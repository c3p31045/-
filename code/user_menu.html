<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>利用会員メニュー</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <a href="login.html" class="title">流山市ファミリーサポートセンター(利用会員用画面)</a>
</header>

<main class="staff-menu2">

  <div class="staff-menu2-inner">

    <!-- 左：カレンダー（本物のカレンダーをはめ込み） -->
    <div class="staff-menu2-left">
      <div class="calendar-box">
        <div class="calendar-header">
          <span id="calendarTitle"></span>
        </div>
        <table class="calendar-table">
          <thead>
          <tr>
            <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
          </tr>
          </thead>
          <tbody id="calendarBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- 右：ボタン3つ＋チャットBOX -->
    <div class="staff-menu2-right">
      <a href="user_member_tabs.php" class="staff-menu2-btn">マイページ</a>
      <a href="support_request.html"  class="staff-menu2-btn">援助依頼</a>
      <a href="confirmed_list.php"    class="staff-menu2-btn">確定日</a>
    </div>

  </div>

</main>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // ヘッダー色の復元
  const savedColor = localStorage.getItem('headerColor');
  if (savedColor) {
    document.querySelector('header').style.background = savedColor;
  }

  const titleEl = document.getElementById('calendarTitle');
  const bodyEl  = document.getElementById('calendarBody');

  const today = new Date();
  const year  = today.getFullYear();
  const month = today.getMonth();

  titleEl.textContent = `${year}年${month + 1}月`;

  const firstDay = new Date(year, month, 1);
  const lastDay  = new Date(year, month + 1, 0);

  bodyEl.innerHTML = "";
  let row = document.createElement('tr');

  for (let i = 0; i < firstDay.getDay(); i++) {
    row.appendChild(document.createElement('td'));
  }

  for (let d = 1; d <= lastDay.getDate(); d++) {

    const cell = document.createElement('td');
    cell.textContent = d;

    const dateStr =
      `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    cell.dataset.date = dateStr;
    cell.classList.add('calendar-cell');

    if (
      d === today.getDate() &&
      year === today.getFullYear() &&
      month === today.getMonth()
    ) {
      cell.classList.add('today');
    }

    // 予定の吹き出し（1日分の予定）
    cell.addEventListener('mouseenter', () => {
      const existing = cell.querySelector('.calendar-tooltip');
      if (existing) existing.remove();

      const tip = document.createElement('div');
      tip.className = 'calendar-tooltip';
      tip.textContent = '読み込み中…';
      cell.appendChild(tip);

      fetch(`get_schedule.php?date=${encodeURIComponent(dateStr)}`)
        .then(res => res.json())
        .then(data => {
          if (data.events && data.events.length > 0) {
            tip.textContent = data.events
              .map(ev => `${ev.start_time} ${ev.title}`)
              .join('\n');
          } else {
            tip.textContent = '予定なし';
          }
        })
        .catch(() => {
          tip.textContent = '取得エラー';
        });
    });

    cell.addEventListener('mouseleave', () => {
      const tip = cell.querySelector('.calendar-tooltip');
      if (tip) tip.remove();
    });

    row.appendChild(cell);

    if ((firstDay.getDay() + d) % 7 === 0) {
      bodyEl.appendChild(row);
      row = document.createElement('tr');
    }
  }

  if (row.children.length > 0) {
    while (row.children.length < 7) {
      row.appendChild(document.createElement('td'));
    }
    bodyEl.appendChild(row);
  }

  // ★ この月で「予定がある日」を強調表示
  const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
  fetch(`get_schedule.php?month=${encodeURIComponent(monthStr)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.dates) return;
      data.dates.forEach(date => {
        const cell = bodyEl.querySelector(`td[data-date="${date}"]`);
        if (cell) {
          cell.classList.add('has-event');   // CSS側で色付け
        }
      });
    })
    .catch(() => {
      // 失敗してもカレンダー自体は動くので無視
    });

});
</script>

</body>
</html>
