<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>確定済みマッチ一覧 | マッチング管理</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background-color: #f5f7fb;
      color: #333;
    }
    header {
      background-color: #166043;
      color: #fff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    main {
      max-width: 960px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }
    .summary {
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }

    .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }
    .card-id {
      font-size: 11px;
      font-weight: 600;
      color: #166043;
    }
    .card-meta {
      font-size: 11px;
      color: #666;
      text-align: right;
      flex-shrink: 0;
    }
    .card-request {
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-line;
    }
    .card-provider {
      font-size: 13px;
      color: #111827;
    }
    .score-line {
      font-size: 12px;
      color: #374151;
    }
    .score-bar {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background-color: #e2e8f0;
      overflow: hidden;
      margin-top: 2px;
    }
    .score-bar-inner {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background-color: #309D62;
      width: 0%;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
      margin-left: 4px;
    }
    .pill-high { background-color: #16a34a; }
    .pill-mid  { background-color: #f59e0b; }
    .pill-low  { background-color: #9ca3af; }

    .status {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
    }
    .error {
      font-size: 13px;
      color: #b91c1c;
      white-space: pre-wrap;
      margin-top: 8px;
      display:none;
    }

    .card-footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
<header>
  <h1>確定済みマッチ一覧</h1>
  <div style="font-size:12px;opacity:0.9;">職員用マッチング管理</div>
</header>

<main>
  <div class="summary" id="summary-text">読み込み中です...</div>
  <div id="card-list" class="card-list">
    <!-- JSでカードを追加 -->
  </div>
  <div id="status-text" class="status"></div>
  <div id="error-text" class="error"></div>
</main>

<script>
(function() {
  const cardListEl = document.getElementById('card-list');
  const summaryEl  = document.getElementById('summary-text');
  const statusEl   = document.getElementById('status-text');
  const errorEl    = document.getElementById('error-text');

  function badge(prob) {
    if (prob === null || prob === undefined || isNaN(prob)) {
      return '';
    }
    if (prob >= 0.8) return '<span class="pill pill-high">高</span>';
    if (prob >= 0.4) return '<span class="pill pill-mid">中</span>';
    return '<span class="pill pill-low">低</span>';
  }

  function render(list) {
    cardListEl.innerHTML = '';

    if (!list || list.length === 0) {
      summaryEl.textContent = '現在、確定済みのマッチングはありません。';
      statusEl.textContent  = '';
      return;
    }

    summaryEl.textContent = '確定済みマッチ ' + list.length + ' 件';
    statusEl.textContent  = '最新の確定状況を表示しています。';

    list.forEach(item => {
      const prob = (typeof item.score === 'number')
        ? item.score
        : (item.score ? Number(item.score) : NaN);
      const pct  = (isNaN(prob) ? null : (prob * 100).toFixed(1));

      const timeLabel =
        (item.request_date || '') +
        (item.start_time ? ' ' + item.start_time : '') +
        (item.end_time ? '〜' + item.end_time : '');

      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.confirmedId = item.confirmed_id;

      card.innerHTML = `
        <div class="card-header">
          <div class="card-id">
            依頼ID: ${item.request_id} / 確定ID: ${item.confirmed_id}
          </div>
          <div class="card-meta">
            ${timeLabel || ''}<br>
            ${item.requester_name ? '依頼者: ' + item.requester_name : ''}
          </div>
        </div>

        <div class="card-request">
          ${item.request_text || '(依頼内容なし)'}
        </div>

        <div class="card-provider">
          提供会員: <strong>${item.provider_name || ('ID:' + item.provider_id)}</strong>
        </div>

        <div class="score-line">
        AI候補: ${
        prob === null ? '（スコア未登録）'
                  : (prob.toFixed(3) + ' ' + badge(prob))
        }

          <div class="score-bar">
            <div class="score-bar-inner" style="width:${pct === null ? 0 : pct}%;"></div>
          </div>
        </div>

        <div class="card-footer">
          <span>確定日時: ${item.created_at ? item.created_at : '不明'}</span>
          <span>依頼日: ${item.request_date || ''}</span>
        </div>
      `;

      cardListEl.appendChild(card);
    });
  }

  async function loadList() {
    summaryEl.textContent = '読み込み中です...';
    statusEl.textContent  = '';
    errorEl.style.display = 'none';
    errorEl.textContent   = '';

    try {
      const res  = await fetch('list_confirmed_matches.php');
      const text = await res.text();

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        errorEl.style.display = 'block';
        errorEl.textContent = 'JSONパースエラー:\n' + e + '\n\nレスポンス:\n' + text;
        summaryEl.textContent = 'エラーが発生しました。';
        return;
      }

      if (data.error) {
        errorEl.style.display = 'block';
        errorEl.textContent   = data.error;
        summaryEl.textContent = 'エラーが発生しました。';
        return;
      }

      render(data);

    } catch (e) {
      errorEl.style.display = 'block';
      errorEl.textContent   = '通信エラー: ' + e;
      summaryEl.textContent = 'エラーが発生しました。';
    }
  }

  loadList();
})();
</script>
</body>
</html>
